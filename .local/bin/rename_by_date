#!/bin/bash
exts=("$@")
if [ ${#exts[@]} -eq 0 ]; then
	printf "Enter file extension(s): " && read -ra exts
fi

for ext in "${exts[@]}"; do
	ext="${ext#.}"
	mapfile -t files < <(find . -mindepth 1 -type f -name "*.$ext" -printf '%P\n')
	if [ -n "$files" ]; then
		echo "${files[@]}"
		printf "Rename all .%s files listed above in \"$(pwd)\"? y/N? " "$ext" && read -rsen 1 answ
	fi

	if [ "$answ" = "y" ]; then
		for f in "${files[@]}"; do

			exifDatetime="$(file "$f" | grep -oP 'datetime=\K[^,\]]*' | sed 's/:/-/; s/:/-/')"

			if [ "$exifDatetime" ]; then
				touch -d "$exifDatetime" "$f"
			fi

			dir="$(dirname "$f")"
			newName="$(date -r "$f" +"%Y%m%d_%H%M%S")"
			if [ -e "$dir/$newName.$ext" ]; then
				num=2
				while [ -f "$newName-$num.$ext" ]; do
					num=$((num += 1))
				done
				newName="$newName-$num"
			fi
			# echo "$f -> $dir/$newName.$ext"
			mv -vn "$f" "$dir/$newName.$ext"

		done
	else
		printf "Skipping %s\n\n" ".$ext"
	fi

done
