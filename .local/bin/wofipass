#!/bin/bash
# shellcheck disable=SC2064

shopt -s nullglob globstar

# typeit=0
if [ "$1" = "--type" ]; then
	echo "--type is unavailable"
	exit 1
	# typeit=1
	# shift
fi

if [ -n "$WAYLAND_DISPLAY" ]; then
	dmenu="wofi -d"
	# xdotool="ydotool type -d 0 --file -"
	copy="wl-copy"
else
	echo "Error: No Wayland display detected" >&2
	exit 1
fi

export PASSWORD_STORE_DIR="$HOME/.local/share/pass"
export PASSWORD_STORE_CLIP_TIME="10"

prefix=${PASSWORD_STORE_DIR-~/.password-store}
password_files=("$prefix"/**/*.gpg)
password_files=("${password_files[@]#"$prefix"/}")
password_files=("${password_files[@]%.gpg}")

password=$(printf '%s\n' "${password_files[@]}" | $dmenu "$@")

[ -n "$password" ] || exit

CLIPHIST_FILE="$HOME/.cache/cliphist/db"
lockclipboard() {
	local restoreClipboard=()
	if [ "$XDG_CURRENT_DESKTOP" = "GNOME" ]; then
		restoreClipboard+=("sleep 3")
		if gnome-extensions show copyous@boerdereinar.dev | grep -q "Enabled: Yes"; then
			gnome-extensions disable copyous@boerdereinar.dev
			restoreClipboard+=("gnome-extensions enable copyous@boerdereinar.dev")
		fi
		if gnome-extensions show clipboard-indicator@tudmotu.com | grep -q "Enabled: Yes"; then
			gnome-extensions disable clipboard-indicator@tudmotu.com
			restoreClipboard+=("gnome-extensions enable clipboard-indicator@tudmotu.com")
		fi
	fi

	if pgrep -f cliphist >/dev/null; then # for hyprland, niri, etc
		if [ -f "$CLIPHIST_FILE" ]; then
			local perm
			perm="$(stat -c "%a" "$CLIPHIST_FILE")"
			restoreClipboard+=("chmod $perm $(printf "%q" "$CLIPHIST_FILE")")
			chmod -w "$CLIPHIST_FILE"
		fi
	fi

	# if [ "$XDG_CURRENT_DESKTOP" = "KDE" ]; then
	# 	# can't be locked, but can be completely cleared
	# 	restoreClipboard+=("qdbus6 org.kde.klipper /klipper org.kde.klipper.klipper.clearClipboardHistory")
	# fi

	if [ ${#restoreClipboard[@]} -gt 0 ]; then
		local restoreClipboardFull
		printf -v restoreClipboardFull '%s; ' "${restoreClipboard[@]}"
		trap "${restoreClipboardFull}trap - HUP INT QUIT TERM PWR EXIT" HUP INT QUIT TERM PWR EXIT
	fi
}

choise="$(printf "1. Password\n2. OTP\n3. Password + OTP\n4. Login\n5. Login + Password + OTP" | $dmenu)"
if ! pass check; then exit 1; fi # exit if gpg key is not unlocked, so options 3 and 5 won't reprompt for password
# `check` is an empty pass file you'll need to create

lockclipboard
case $choise in
	1*)
		pass show -c "$password" 2>/dev/null
		;;

	2*)
		pass otp -c "$password" 2>/dev/null
		;;

	3*)
		pass show -c "$password" 2>/dev/null
		sleep 3
		pass otp -c "$password" 2>/dev/null
		;;

	4*)
		pass show "$password" 2>/dev/null | grep -F "Login: " | cut -d' ' -f2 | $copy
		;;

	5*)
		pass show "$password" 2>/dev/null | grep -F "Login: " | cut -d' ' -f2 | $copy
		sleep 2
		pass show -c "$password" 2>/dev/null
		sleep 3
		pass otp -c "$password" 2>/dev/null
		;;
esac
